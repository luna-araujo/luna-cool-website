---
import "../styles/global.css";

const { title = "Luna AraÃºjo", description = "Personal website" } = Astro.props;
const basePath = import.meta.env.BASE_URL;

const currentPath = Astro.url.pathname.replace(/\/$/, "");
const rootPath = basePath === "/" ? "" : basePath.replace(/\/$/, "");
const isActive = (path: string) => {
  const normalized = path.replace(/\/$/, "");
  if (normalized === "") return currentPath === rootPath;
  return currentPath.startsWith(`${rootPath}${normalized}`);
};
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" href={basePath + "favicon.svg"} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="top-gradient" aria-hidden="true"></div>
    <div id="cursor-block" class="cursor-block" aria-hidden="true"></div>
    <main class="container">
      <slot />
    </main>
    <script>
      const cursor = document.getElementById("cursor-block");

      // Persist cursor position across navigations in the same tab using sessionStorage.
      // This prevents the cursor block from snapping back to the offscreen default when pages change.
      if (cursor && !window.matchMedia("(pointer: coarse)").matches) {
        const storageKey = "luna:cursorPos";
        let x = -9999;
        let y = -9999;
        let targetX = -9999;
        let targetY = -9999;
        const offset = { x: 14, y: 14 };
        const ease = window.matchMedia("(prefers-reduced-motion: reduce)").matches ? 1 : 0.18;

        // Restore last known position (if present) so the element doesn't jump on navigation
        try {
          const raw = sessionStorage.getItem(storageKey);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (typeof parsed.x === 'number' && typeof parsed.y === 'number') {
              targetX = parsed.x;
              targetY = parsed.y;
              x = parsed.x;
              y = parsed.y;
              cursor.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
            }
          }
        } catch (e) {
          // ignore parse/storage errors
        }

        const tick = () => {
          x += (targetX - x) * ease;
          y += (targetY - y) * ease;
          cursor.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
          requestAnimationFrame(tick);
        };

        requestAnimationFrame(tick);

        window.addEventListener("mousemove", (e) => {
          targetX = e.clientX + offset.x;
          targetY = e.clientY + offset.y;
          try {
            sessionStorage.setItem(storageKey, JSON.stringify({ x: targetX, y: targetY }));
          } catch (err) {
            // ignore storage quota errors
          }
        });

        window.addEventListener("mouseleave", () => {
          targetX = -9999;
          targetY = -9999;
          try {
            sessionStorage.removeItem(storageKey);
          } catch (err) {}
        });

        // Save final position before the page unloads (helps when navigating away)
        window.addEventListener('beforeunload', () => {
          try {
            sessionStorage.setItem(storageKey, JSON.stringify({ x: targetX, y: targetY }));
          } catch (err) {}
        });
      }
    </script>

    <nav class="bottom-nav" aria-label="Primary">
      <div class="bottom-nav__inner">
        <a
          href={basePath}
          class={`bottom-nav__link ${isActive("") ? "is-active" : ""}`}
        >
          home
        </a>
        <a
          href={basePath + "projects"}
          class={`bottom-nav__link ${isActive("/projects") ? "is-active" : ""}`}
        >
          portfolio
        </a>
        <a
          href={basePath + "about"}
          class={`bottom-nav__link ${isActive("/about") ? "is-active" : ""}`}
        >
          about
        </a>
        <a
          href={basePath + "blog"}
          class={`bottom-nav__link ${isActive("/blog") ? "is-active" : ""}`}
        >
          blog
        </a>
      </div>
    </nav>
  </body>
</html>
