---
import "../styles/themes.css";
import "../styles/global.css";
import themeToolsUrl from "../scripts/theme-tools.js?url";

const { title = "Luna AraÃºjo", description = "Personal website" } = Astro.props;
const basePath = import.meta.env.BASE_URL;

const currentPath = Astro.url.pathname.replace(/\/$/, "");
const rootPath = basePath === "/" ? "" : basePath.replace(/\/$/, "");
const isActive = (path: string) => {
  const normalized = path.replace(/\/$/, "");
  if (normalized === "") return currentPath === rootPath;
  return currentPath.startsWith(`${rootPath}${normalized}`);
};
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <script>
      (() => {
        const storageKey = "luna:theme";
        const themes = new Set([
          "light",
          "light-rosepine",
          "dark",
          "dark-reference",
          "dark-legacy",
          "dark-gruvbox",
          "dark-tokyonight",
          "dark-rosepine",
        ]);
        const saved = (() => {
          try {
            return localStorage.getItem(storageKey);
          } catch {
            return null;
          }
        })();

        const systemPrefersDark = (() => {
          try {
            return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          } catch {
            return false;
          }
        })();

        const theme = saved && themes.has(saved) ? saved : (systemPrefersDark ? "dark-reference" : "light");
        document.documentElement.dataset.theme = theme;
      })();
    </script>
    <link rel="icon" href={basePath + "home-icon.svg"} type="image/svg+xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="top-gradient" aria-hidden="true"></div>
    <div id="cursor-block" class="cursor-block" aria-hidden="true"></div>
    <main class="container">
      <slot />
    </main>
    <script>
      const cursor = document.getElementById("cursor-block");

      // Persist cursor position across navigations in the same tab using sessionStorage.
      // This prevents the cursor block from snapping back to the offscreen default when pages change.
      if (cursor && !window.matchMedia("(pointer: coarse)").matches) {
        const storageKey = "luna:cursorPos";
        let x = -9999;
        let y = -9999;
        let targetX = -9999;
        let targetY = -9999;
        const offset = { x: 12, y: -4 };
        const ease = window.matchMedia("(prefers-reduced-motion: reduce)").matches ? 1 : 0.18;

        // Restore last known position (if present) so the element doesn't jump on navigation
        try {
          const raw = sessionStorage.getItem(storageKey);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (typeof parsed.x === 'number' && typeof parsed.y === 'number') {
              targetX = parsed.x;
              targetY = parsed.y;
              x = parsed.x;
              y = parsed.y;
              cursor.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
            }
          }
        } catch (e) {
          // ignore parse/storage errors
        }

        const tick = () => {
          x += (targetX - x) * ease;
          y += (targetY - y) * ease;
          cursor.style.transform = `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`;
          requestAnimationFrame(tick);
        };

        requestAnimationFrame(tick);

        window.addEventListener("mousemove", (e) => {
          targetX = e.clientX + offset.x;
          targetY = e.clientY + offset.y;
          try {
            sessionStorage.setItem(storageKey, JSON.stringify({ x: targetX, y: targetY }));
          } catch (err) {
            // ignore storage quota errors
          }
        });

        window.addEventListener("mouseleave", () => {
          targetX = -9999;
          targetY = -9999;
          try {
            sessionStorage.removeItem(storageKey);
          } catch (err) {}
        });

        // Save final position before the page unloads (helps when navigating away)
        window.addEventListener('beforeunload', () => {
          try {
            sessionStorage.setItem(storageKey, JSON.stringify({ x: targetX, y: targetY }));
          } catch (err) {}
        });
      }
    </script>

    <nav class="bottom-nav" aria-label="Primary">
      <div class="bottom-nav__inner">
        <a
          href={basePath}
          class={`bottom-nav__link ${isActive("") ? "is-active" : ""}`}
          aria-label="Home"
        >
          <span class="bottom-nav__icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 46.24 47.55" fill="currentColor">
              <g>
                <g>
                  <path d="M31.6,5.26h2.17v2.17c0,.41.34.75.75.75s.75-.34.75-.75v-2.17h2.17c.41,0,.75-.34.75-.75s-.34-.75-.75-.75h-2.17V1.59c0-.41-.34-.75-.75-.75s-.75.34-.75.75v2.17h-2.17c-.41,0-.75.34-.75.75s.34.75.75.75Z" />
                  <path d="M39.03,14.42h1.48v1.48c0,.41.34.75.75.75s.75-.34.75-.75v-1.48h1.48c.41,0,.75-.34.75-.75s-.34-.75-.75-.75h-1.48v-1.48c0-.41-.34-.75-.75-.75s-.75.34-.75.75v1.48h-1.48c-.41,0-.75.34-.75.75s.34.75.75.75Z" />
                  <path d="M45.26,22.6c-3,.65-6.13.52-9.09-.37-9.14-2.76-14.51-12.06-12.53-21.23.14-.64-.49-1.18-1.1-.93-6.73,2.7-11.43,9.26-11.43,17,0,2.83.7,5.56,1.94,8.02-.11.11-.22.22-.32.33-.08.08-.16.17-.23.26-.13.15-.26.3-.38.45-.07.09-.14.18-.21.27-.42.56-.78,1.16-1.09,1.8-.04.08-.08.17-.12.25-.09.2-.17.41-.25.62-.02.04-.03.08-.05.12-5.59-.73-10.39,3.67-10.39,9.15,0,.27.01.54.04.8.09,1.08.38,2.13.83,3.1,1.42,3.24,4.1,5.33,6.82,5.33h21.97c2.72,0,5.4-2.09,6.81-5.31.46-.99.75-2.04.84-3.11.03-.27.04-.54.04-.8,0-1.65-.46-3.21-1.24-4.57,4.46-1.81,8.19-5.32,10.08-10.05.24-.6-.29-1.24-.92-1.1ZM35.31,38.94s0,0,0,.01c-.07.84-.29,1.66-.67,2.46-.9,2.06-2.8,4.14-4.99,4.14H7.69c-2.19,0-4.08-2.08-5-4.16-.36-.78-.59-1.6-.66-2.45-.02-.21-.03-.41-.03-.61,0-3.98,3.24-7.22,7.22-7.22.21,0,.43.02.65.04-.11.62-.18,1.26-.18,1.91,0,.55.45,1,1,1s1-.45,1-1c0-.86.13-1.69.35-2.48.06-.22.13-.43.21-.65.02-.04.03-.09.05-.13.08-.2.16-.39.24-.59.02-.05.05-.1.07-.15.09-.19.19-.38.29-.56.02-.03.03-.05.05-.08.35-.59.75-1.14,1.22-1.63.03-.03.06-.07.09-.1.14-.14.28-.28.42-.41.05-.04.1-.09.15-.13.15-.13.3-.25.45-.37.05-.04.10-.07.15-.11.16-.12.33-.24.5-.35.03-.02.05-.03.08-.05.55-.34,1.13-.63,1.74-.86.08-.03.17-.06.25-.09.15-.05.3-.09.45-.14.12-.03.25-.07.37-.1.13-.03.27-.06.4-.09.16-.03.33-.05.49-.08.11-.01.22-.03.33-.04.28-.03.57-.04.86-.04,3.74,0,7.04,2.25,8.47,5.61-1-.07-2.02,0-2.98.28-.53.15-.84.71-.69,1.24.15.53.71.84,1.24.69,1.34-.38,3.42-.28,4.33.2,2.45,1.2,4.06,3.69,4.06,6.47,0,.2-.01.41-.03.61Z" />
                </g>
              </g>
            </svg>
          </span>
          <span class="bottom-nav__label">home</span>
        </a>
        <a
          href={basePath + "projects"}
          class={`bottom-nav__link ${isActive("/projects") ? "is-active" : ""}`}
          aria-label="Portfolio"
        >
          <span class="bottom-nav__icon fa-solid fa-briefcase" aria-hidden="true"></span>
          <span class="bottom-nav__label">portfolio</span>
        </a>
        <a
          href={basePath + "about"}
          class={`bottom-nav__link ${isActive("/about") ? "is-active" : ""}`}
          aria-label="About"
        >
          <span class="bottom-nav__icon fa-solid fa-user" aria-hidden="true"></span>
          <span class="bottom-nav__label">about</span>
        </a>
        <a
          href={basePath + "contact"}
          class={`bottom-nav__link ${isActive("/contact") ? "is-active" : ""}`}
          aria-label="Contact"
        >
          <span class="bottom-nav__icon fa-solid fa-envelope" aria-hidden="true"></span>
          <span class="bottom-nav__label">contact</span>
        </a>
        <!-- <a
          href={basePath + "blog"}
          class={`bottom-nav__link ${isActive("/blog") ? "is-active" : ""}`}
          aria-label="Blog"
        >
          <span class="bottom-nav__icon fa-solid fa-pen-nib" aria-hidden="true"></span>
          <span class="bottom-nav__label">blog</span>
        </a> -->
        <button
          id="theme-toggle"
          type="button"
          class="bottom-nav__theme-toggle"
          aria-label="Toggle dark mode"
          title="Toggle theme"
        >
          <i class="fa-solid fa-sun" aria-hidden="true"></i>
        </button>
      </div>
    </nav>

    <script type="module" src={themeToolsUrl}></script>
  </body>
</html>
