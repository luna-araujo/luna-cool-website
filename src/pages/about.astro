---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../styles/about.css";

type AboutCard = {
  id: string;
  title: string;
  accent: "accent" | "accent-alt";
  x: number;
  y: number;
  w: number;
  open?: boolean;
  kind: "text" | "tags";
  text?: string[];
  tags?: string[];
};

const basePath = import.meta.env.BASE_URL;

const cssAccentFor = (accent: AboutCard["accent"]) =>
  accent === "accent" ? "var(--accent)" : "var(--accent-alt)";

const cards: AboutCard[] = [
  {
    id: "who",
    title: "Who am I?",
    accent: "accent",
    x: 84,
    y: 120,
    w: 460,
    open: true,
    kind: "text",
    text: [
      "My main role is as a Game Designer, but I consider myself a generalist professional.",
      "Since designing experiences is one of my biggest passions, I've been interested in many different activities throughout my life, such as video editing, scripting, animating, drawing, developing websites and apps…",
      "Today I dedicate myself to creating games, but I know that each one of these activities were fundamental to my career.",
    ],
  },
  {
    id: "workwithme",
    title: "What's like working with me",
    accent: "accent",
    x: 700,
    y: 78,
    w: 520,
    open: false,
    kind: "text",
    text: [
      "I care about clarity, fast iteration, and keeping things shippable.",
      "I like pairing with engineers and artists early so we can find the fun quickly and polish with intention.",
    ],
  },
  {
    id: "skills",
    title: "Skills",
    accent: "accent-alt",
    x: 590,
    y: 190,
    w: 420,
    open: false,
    kind: "tags",
    tags: ["English B2-C1", "Prototyping", "Documentation", "Scripting", "Probability and Statistics"],
  },
  {
    id: "softskills",
    title: "Soft skills",
    accent: "accent-alt",
    x: 360,
    y: 520,
    w: 360,
    open: false,
    kind: "tags",
    tags: ["Communication", "Collaboration", "Ownership", "Feedback", "Adaptability"],
  },
  {
    id: "tools",
    title: "Tools and softwares",
    accent: "accent-alt",
    x: 630,
    y: 420,
    w: 520,
    open: false,
    kind: "tags",
    tags: ["Unity Engine", "C#", "Git", "HTML", "CSS", "JavaScript", "Node.js", "Electron"],
  },
  {
    id: "experience",
    title: "My experiences",
    accent: "accent",
    x: 980,
    y: 310,
    w: 320,
    open: false,
    kind: "text",
    text: [
      "Game jams, indie prototypes, and shipped casino/video-bingo titles.",
      "I enjoy bridging design + implementation, especially for UI/UX and moment-to-moment feel.",
    ],
  },
  {
    id: "games",
    title: "Games I love",
    accent: "accent-alt",
    x: 1090,
    y: 540,
    w: 300,
    open: false,
    kind: "tags",
    tags: ["Celeste", "Hades", "Undertale", "Katamari", "Slay the Spire"],
  },
];
---
<BaseLayout title="About — Luna Araújo" description="About Luna Araújo">
  <section class="about-stage" aria-label="About cards">
    {cards.map((card) => (
      <section
        class="about-card"
        data-about-card
        data-id={card.id}
        data-open={card.open ? "true" : "false"}
        style={`--x:${card.x}px; --y:${card.y}px; --w:${card.w}px; --card-accent-base:${cssAccentFor(card.accent)}; z-index: 1;`}
        tabindex="0"
      >
        <header class="about-card__header">
          <h2 class="about-card__title">{card.title}</h2>
          <div class="about-card__controls">
            <button class="about-card__drag" type="button" aria-label="Drag card" title="Drag">
              ⠿
            </button>
            <button
              class="about-card__toggle"
              type="button"
              aria-label="Toggle card"
              aria-expanded={card.open ? "true" : "false"}
            >
              {card.open ? "−" : "+"}
            </button>
          </div>
        </header>

        <div class="about-card__body">
          {card.kind === "text" && (
            <div class="about-card__text">
              {(card.text ?? []).map((p) => (
                <p class="mb-3">{p}</p>
              ))}
              {card.id === "who" && (
                <p class="about-card__text">
                  See my work in <a class="link" href={basePath + "projects"}>projects</a>.
                </p>
              )}
            </div>
          )}

          {card.kind === "tags" && (
            <div class="about-tags" role="list" aria-label={`${card.title} list`}>
              {(card.tags ?? []).map((tag) => (
                <span class="about-tag" role="listitem">{tag}</span>
              ))}
            </div>
          )}
        </div>
      </section>
    ))}
  </section>

  <script>
    const stage = document.querySelector<HTMLElement>(".about-stage");
    const cards = Array.from(document.querySelectorAll<HTMLElement>("[data-about-card]"));

    if (stage && cards.length) {
      let topZ = 10;

      const bringToFront = (card: HTMLElement) => {
        topZ += 1;
        card.style.zIndex = String(topZ);
      };

      const getVarPx = (el: HTMLElement, name: string) => {
        const raw = getComputedStyle(el).getPropertyValue(name).trim();
        const num = parseFloat(raw.replace("px", ""));
        return Number.isFinite(num) ? num : 0;
      };

      const clamp = (v: number, min: number, max: number) => Math.min(max, Math.max(min, v));

      const clampCardIntoStage = (card: HTMLElement) => {
        const stageRect = stage.getBoundingClientRect();
        const cardRect = card.getBoundingClientRect();

        const maxX = Math.max(0, stageRect.width - cardRect.width);
        const maxY = Math.max(0, stageRect.height - cardRect.height);

        const x = getVarPx(card, "--x");
        const y = getVarPx(card, "--y");
        const nextX = clamp(x, 0, maxX);
        const nextY = clamp(y, 0, maxY);

        if (nextX !== x) card.style.setProperty("--x", `${nextX}px`);
        if (nextY !== y) card.style.setProperty("--y", `${nextY}px`);
      };

      for (const card of cards) {
        const toggle = card.querySelector<HTMLButtonElement>(".about-card__toggle");
        const drag = card.querySelector<HTMLButtonElement>(".about-card__drag");

        card.addEventListener("pointerdown", (e: PointerEvent) => {
          // Don't steal clicks from the toggle button.
          const target = e.target as HTMLElement | null;
          if (target?.closest(".about-card__toggle")) return;
          bringToFront(card);
        });

        card.addEventListener("focus", () => bringToFront(card));

        if (toggle) {
          toggle.addEventListener("click", () => {
            bringToFront(card);
            const open = card.getAttribute("data-open") === "true";
            const next = !open;
            card.setAttribute("data-open", next ? "true" : "false");
            toggle.setAttribute("aria-expanded", next ? "true" : "false");
            toggle.textContent = next ? "−" : "+";

            // Expansion changes card height; keep it inside the stage.
            requestAnimationFrame(() => clampCardIntoStage(card));
          });
        }

        if (drag) {
          let startX = 0;
          let startY = 0;
          let baseX = 0;
          let baseY = 0;
          let dragging = false;

          drag.addEventListener("pointerdown", (e: PointerEvent) => {
            bringToFront(card);
            dragging = true;
            card.classList.add("is-dragging");
            drag.setPointerCapture(e.pointerId);

            startX = e.clientX;
            startY = e.clientY;
            baseX = getVarPx(card, "--x");
            baseY = getVarPx(card, "--y");
            e.preventDefault();
          });

          drag.addEventListener("pointermove", (e: PointerEvent) => {
            if (!dragging) return;

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            let nextX = baseX + dx;
            let nextY = baseY + dy;

            // Keep the card mostly within the stage bounds on desktop.
            const stageRect = stage.getBoundingClientRect();
            const cardRect = card.getBoundingClientRect();

            const maxX = Math.max(0, stageRect.width - cardRect.width);
            const maxY = Math.max(0, stageRect.height - cardRect.height);
            nextX = clamp(nextX, 0, maxX);
            nextY = clamp(nextY, 0, maxY);

            card.style.setProperty("--x", `${nextX}px`);
            card.style.setProperty("--y", `${nextY}px`);
          });

          const endDrag = () => {
            if (!dragging) return;
            dragging = false;
            card.classList.remove("is-dragging");

            // If the card changed size while dragging (or stage resized), re-clamp.
            clampCardIntoStage(card);
          };

          drag.addEventListener("pointerup", endDrag);
          drag.addEventListener("pointercancel", endDrag);
        }

        // Ensure initial positions are valid for the current viewport.
        clampCardIntoStage(card);
      }

      window.addEventListener("resize", () => {
        for (const card of cards) clampCardIntoStage(card);
      });
    }
  </script>
</BaseLayout>
