---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import fs from "node:fs";
import path from "node:path";

import "../../styles/project-detail.css";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((project) => ({ params: { slug: project.slug }, props: { project } }));
}

const { project } = Astro.props;
const { Content } = await project.render();

const basePath = import.meta.env.BASE_URL;

// Check if gallery folder exists
const galleryPath = path.join(process.cwd(), "public", "images", "projects", project.slug, "gallery");
const hasGallery = fs.existsSync(galleryPath);

// Get actual gallery images that exist
let galleryImages: string[] = [];
if (hasGallery) {
  try {
    const files = fs.readdirSync(galleryPath);
    const imageFiles = files.filter(file => /\.(png|jpg|jpeg|gif|webp)$/i.test(file));
    galleryImages = imageFiles
      .sort((a, b) => {
        const numA = parseInt(a.match(/\d+/)?.[0] || '0');
        const numB = parseInt(b.match(/\d+/)?.[0] || '0');
        return numA - numB;
      })
      .map(file => basePath + `images/projects/${project.slug}/gallery/${file}`);
  } catch (e) {
    galleryImages = [];
  }
}
---
<BaseLayout title={`${project.data.title} — Luna Araújo`} description={project.data.summary}>
  <article class="project-detail">
    {project.data.image && (
      <div class="project-detail__mobileCover">
        <img
          class="project-detail__coverImage"
          src={basePath + project.data.image.slice(1)}
          alt={project.data.title}
        />
      </div>
    )}

    <header class="project-detail__header">
      <h1 class="project-detail__title">{project.data.title}</h1>
      <div class="project-detail__meta project-detail__meta--mobile">
        {project.data.summary && <p class="project-detail__summary">{project.data.summary}</p>}
        {project.data.role && <p class="project-detail__role">{project.data.role}</p>}
        {project.data.year && <p class="project-detail__year">{project.data.year}</p>}
        {project.data.link && (
          <a href={project.data.link} target="_blank" rel="noopener noreferrer" class="project-detail__link">
            Visit Project <span>→</span>
          </a>
        )}
      </div>
    </header>

    {project.data.image && (
      <div class="project-detail__cover">
        <img
          class="project-detail__coverImage"
          src={basePath + project.data.image.slice(1)}
          alt={project.data.title}
        />
        <div class="project-detail__meta project-detail__meta--desktop">
          {project.data.summary && <p class="project-detail__summary">{project.data.summary}</p>}
          {project.data.role && <p class="project-detail__role">{project.data.role}</p>}
          {project.data.year && <p class="project-detail__year">{project.data.year}</p>}
          {project.data.link && (
            <a href={project.data.link} target="_blank" rel="noopener noreferrer" class="project-detail__link">
              Visit Project <span>→</span>
            </a>
          )}
        </div>
      </div>
    )}

    <div class="project-detail__body">
      <div class="project-detail__content prose max-w-none">
        <Content />
      </div>
    </div>

    {hasGallery && galleryImages.length > 0 && (
      <section class="project-detail__gallery">
        <h2 class="project-detail__galleryTitle">Gallery</h2>
        <div class="project-detail__galleryWrapper">
          <button class="project-detail__galleryBtn project-detail__galleryBtn--prev" aria-label="Previous image">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6"></path>
            </svg>
          </button>
          <div class="project-detail__galleryGrid" id="gallery-scroll">
            {galleryImages.map((imageSrc, index) => (
              <img
                src={imageSrc}
                alt={`${project.data.title} screenshot ${index + 1}`}
                class={`project-detail__galleryImage ${index === 0 ? 'active' : ''}`}
                loading="lazy"
                data-index={index}
              />
            ))}
          </div>
          <button class="project-detail__galleryBtn project-detail__galleryBtn--next" aria-label="Next image">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6"></path>
            </svg>
          </button>
        </div>
        {galleryImages.length > 1 && (
          <div class="project-detail__galleryCounter">
            <span id="gallery-current">1</span> / {galleryImages.length}
          </div>
        )}
      </section>
    )}

    <div class="project-detail__footer">
      <a class="project-detail__back" href={basePath + "projects"}>
        ← Back to Projects
      </a>
    </div>
  </article>

  {hasGallery && galleryImages.length > 0 && (
    <dialog id="lightbox" class="project-detail__lightbox">
      <button id="lightbox-close" class="project-detail__lightboxClose" aria-label="Close">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <button id="lightbox-prev" class="project-detail__lightboxNav project-detail__lightboxNav--prev" aria-label="Previous image">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="icon-arrow rotate-left">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6"></path>
        </svg>
      </button>
      <img id="lightbox-img" class="project-detail__lightboxImage" src="" alt="Full size view" />
      <button id="lightbox-next" class="project-detail__lightboxNav project-detail__lightboxNav--next" aria-label="Next image">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="icon-arrow rotate-right">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6"></path>
        </svg>
      </button>
    </dialog>
  )}

  {hasGallery && galleryImages.length > 0 && (
    <script define:vars={{ galleryImages }}>
      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightbox-img');
      const closeLightbox = document.getElementById('lightbox-close');
      const lightboxPrev = document.getElementById('lightbox-prev');
      const lightboxNext = document.getElementById('lightbox-next');
      const galleryImagesEl = document.querySelectorAll('.project-detail__galleryImage');

      // Gallery slideshow
      const galleryPrevBtn = document.querySelector('.project-detail__galleryBtn--prev');
      const galleryNextBtn = document.querySelector('.project-detail__galleryBtn--next');
      const galleryCurrent = document.getElementById('gallery-current');
      let galleryIndex = 0;

      const updateGallerySlide = () => {
        galleryImagesEl.forEach((img, i) => {
          img.classList.toggle('active', i === galleryIndex);
        });
        if (galleryCurrent) {
          galleryCurrent.textContent = galleryIndex + 1;
        }
        // Hide buttons if only one image
        if (galleryImages.length <= 1) {
          galleryPrevBtn?.classList.add('hidden');
          galleryNextBtn?.classList.add('hidden');
        }
      };

      if (galleryPrevBtn && galleryNextBtn) {
        galleryPrevBtn.addEventListener('click', () => {
          galleryIndex = (galleryIndex - 1 + galleryImages.length) % galleryImages.length;
          updateGallerySlide();
        });

        galleryNextBtn.addEventListener('click', () => {
          galleryIndex = (galleryIndex + 1) % galleryImages.length;
          updateGallerySlide();
        });

        updateGallerySlide();
      }

      let currentImageIndex = 0;

      function updateLightboxButtons() {
        if (galleryImages.length <= 1) {
          lightboxPrev?.classList.add('hidden');
          lightboxNext?.classList.add('hidden');
        } else {
          lightboxPrev?.classList.remove('hidden');
          lightboxNext?.classList.remove('hidden');
        }
      }

      function showLightbox(imageSrc, index) {
        currentImageIndex = index;
        lightboxImg.src = imageSrc;
        lightbox.showModal();
        document.body.style.overflow = 'hidden';
        updateLightboxButtons();
      }

      function hideLightbox() {
        lightbox.close();
        document.body.style.overflow = '';
      }

      // Open lightbox on image click
      galleryImagesEl.forEach((img, index) => {
        img.addEventListener('click', () => {
          showLightbox(galleryImages[index], index);
        });
      });

      // Close lightbox
      closeLightbox?.addEventListener('click', hideLightbox);
      lightbox?.addEventListener('click', (e) => {
        if (e.target === lightbox) hideLightbox();
      });

      // Lightbox navigation
      lightboxPrev?.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
        lightboxImg.src = galleryImages[currentImageIndex];
      });

      lightboxNext?.addEventListener('click', () => {
        currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
        lightboxImg.src = galleryImages[currentImageIndex];
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (lightbox.open) {
          if (e.key === 'Escape') hideLightbox();
          if (e.key === 'ArrowLeft') lightboxPrev?.click();
          if (e.key === 'ArrowRight') lightboxNext?.click();
        }
      });
    </script>
  )}
</BaseLayout>
