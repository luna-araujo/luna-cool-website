---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import "../../styles/project-card.css";
import "../../styles/projects-view.css";
import fs from "node:fs";
import path from "node:path";

const basePath = import.meta.env.BASE_URL;
const projectsRaw = (await getCollection("projects")).sort((a, b) => parseInt(b.data.year || '0') - parseInt(a.data.year || '0'));

const projects = await Promise.all(projectsRaw.map(async (project) => {
  const { Content } = await project.render();
  
  const galleryPath = path.join(process.cwd(), "public", "images", "projects", project.slug, "gallery");
  const hasGallery = fs.existsSync(galleryPath);
  let galleryImages: string[] = [];
  
  if (hasGallery) {
      try {
          const files = fs.readdirSync(galleryPath);
          const imageFiles = files.filter(file => /\.(png|jpg|jpeg|gif|webp)$/i.test(file));
          galleryImages = imageFiles
            .sort((a, b) => {
              const numA = parseInt(a.match(/\d+/)?.[0] || '0');
              const numB = parseInt(b.match(/\d+/)?.[0] || '0');
              return numA - numB;
            })
            .map(file => basePath + `images/projects/${project.slug}/gallery/${file}`);
      } catch (e) {
          /* ignore */
      }
  }
  
  // Combine main image and gallery images into one list for the slideshow
  const allImages = [];
  if (project.data.image) {
      allImages.push(basePath + project.data.image.slice(1));
  }
  allImages.push(...galleryImages);
  
  return {
      slug: project.slug,
      data: project.data,
      Content,
      slides: allImages
  };
}));
---

<BaseLayout title="Projects — Luna Araújo" description="Portfolio projects">
<div class="page-container">
  <div class="carousel-wrapper">
    <!-- Previous Button -->
    <button id="prev-btn" class="nav-btn" aria-label="Previous project">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-arrow rotate-left">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6" />
      </svg>
    </button>

    <!-- Carousel Viewport -->
    <div class="viewport">
      <div class="track" id="track">
        {projects.map((item) => (
          <button
            type="button"
            class="project-card carousel-item text-left cursor-pointer"
            data-target={`#modal-${item.slug}`}
            data-href={basePath + `projects/${item.slug}`}
          >
            {item.data.image && (
              <img src={basePath + item.data.image.slice(1)} alt={item.data.title} />
            )}
            <h3>{item.data.title}</h3>
            <p>{item.data.summary}</p>
            <div class="project-meta">
              <span>{item.data.year}</span>
            </div>
          </button>
        ))}
      </div>
    </div>

    <!-- Next Button -->
    <button id="next-btn" class="nav-btn" aria-label="Next project">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-arrow rotate-right">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6" />
      </svg>
    </button>
  </div>
</div>

<!-- Project Modals -->
{projects.map((item) => (
  <dialog id={`modal-${item.slug}`} class="project-modal" aria-hidden="true">
    <div class="modal-inner">
      <button class="modal-close-btn" aria-label="Close modal"></button>

      <div class="modal-content-grid">
        <!-- Left Column: Slideshow -->
        <div class="modal-media-col" id={`gallery-${item.slug}`}>
          <div class="modal-media-header">
            <a href={basePath + `projects/${item.slug}`} class="modal-title-link">
              <h2 class="modal-title">{item.data.title}</h2>
            </a>
          </div>

          {item.slides.length > 0 ? (
            <div class="gallery-slideshow" data-slides={JSON.stringify(item.slides)}>
               <button class="gallery-ctrl-btn prev" aria-label="Previous image" hidden={item.slides.length <= 1}>
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 icon-arrow rotate-left">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6" />
                 </svg>
               </button>
               
               <img 
                 src={item.slides[0]} 
                 alt={item.data.title} 
                 class="slide-image cursor-pointer"
                 data-index="0"
               />
               
               <button class="gallery-ctrl-btn next" aria-label="Next image" hidden={item.slides.length <= 1}>
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 icon-arrow rotate-right">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-6 6m6-6l6 6" />
                 </svg>
               </button>

               {item.slides.length > 1 && (
                  <div class="gallery-counter">1 / {item.slides.length}</div>
               )}
            </div>
          ) : (
            <div class="bg-gray-800 w-full aspect-video flex items-center justify-center text-gray-500">
               No Image
            </div>
          )}

          {item.data.year ? (
            <div class="modal-media-footer">
              <span class="modal-media-date">{item.data.year}</span>
            </div>
          ) : null}
        </div>

        <!-- Right Column: Text Content -->
        <div class="modal-info-col">
          {item.data.role && (
            <div class="modal-meta-row">
              <span class="meta-tag">{item.data.role.toUpperCase()}</span>
            </div>
          )}
          
          <div class="prose prose-invert max-w-none modal-description">
            <item.Content />
          </div>

          <div class="modal-footer">
             {item.data.link && (
               <a href={item.data.link} target="_blank" rel="noopener noreferrer" class="play-link">
                 Visit Project <span class="arrow">→</span>
               </a>
             )}
          </div>
        </div>
      </div>
    </div>
  </dialog>
))}

<!-- Lightbox Overlay (Shared) -->
<dialog id="lightbox" class="lightbox-overlay">
    <button id="lightbox-close" class="lightbox-close" aria-label="Close Lightbox">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>
    <div class="lightbox-content">
        <img id="lightbox-img" src="" alt="Full size view" />
    </div>
</dialog>

</BaseLayout>

<script>
  // --- Carousel Logic for Project Cards (Preserved) ---
  const track = document.getElementById('track');
  const viewport = document.querySelector('.viewport');
  const nextBtn = document.getElementById('next-btn');
  const prevBtn = document.getElementById('prev-btn');

  const useNativeScrollCarousel = window.matchMedia('(max-width: 640px)').matches;

  if (useNativeScrollCarousel) {
    // On mobile: use native horizontal scrolling with smooth scroll behavior
    if (nextBtn && prevBtn && viewport) {
      nextBtn.addEventListener('click', () => {
        const scrollAmount = viewport.clientWidth * 0.8; // Scroll ~80% of viewport width
        viewport.scrollBy({ left: scrollAmount, behavior: 'smooth' });
      });

      prevBtn.addEventListener('click', () => {
        const scrollAmount = viewport.clientWidth * 0.8;
        viewport.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
      });
    }
  } else {
    // Desktop: use DOM manipulation carousel
    let isAnimating = false;

    const moveNext = () => {
      if (isAnimating || !track) return;
      const style = window.getComputedStyle(track);
      const gap = parseFloat(style.gap) || 0;
      const firstChild = track.firstElementChild;
      const itemWidth = firstChild ? firstChild.getBoundingClientRect().width : 0;
      const moveAmount = itemWidth + gap;

      isAnimating = true;
      track.style.transition = 'transform 0.5s ease-in-out';
      track.style.transform = `translateX(-${moveAmount}px)`;

      const transitionEnd = () => {
        track.removeEventListener('transitionend', transitionEnd);
        track.style.transition = 'none';
        if (firstChild) track.appendChild(firstChild);
        track.style.transform = 'translateX(0)';
        setTimeout(() => { isAnimating = false; }, 10);
      };
      track.addEventListener('transitionend', transitionEnd);
    };

    const movePrev = () => {
      if (isAnimating || !track) return;
      const style = window.getComputedStyle(track);
      const gap = parseFloat(style.gap) || 0;
      const lastChild = track.lastElementChild;
      if (!lastChild) return;

      const itemWidth = lastChild.getBoundingClientRect().width;
      const moveAmount = itemWidth + gap;

      isAnimating = true;
      track.style.transition = 'none';
      track.insertBefore(lastChild, track.firstElementChild);
      track.style.transform = `translateX(-${moveAmount}px)`;
      void track.offsetHeight;
      track.style.transition = 'transform 0.5s ease-in-out';
      track.style.transform = 'translateX(0)';

      const transitionEnd = () => {
        track.removeEventListener('transitionend', transitionEnd);
        isAnimating = false;
      };
      track.addEventListener('transitionend', transitionEnd);
    };

    if (nextBtn && prevBtn) {
      nextBtn.addEventListener('click', moveNext);
      prevBtn.addEventListener('click', movePrev);

      // Add keyboard arrow key support
      window.addEventListener('keydown', (e) => {
        // Don't trigger if user is typing in an input or modal is open
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' ||
            document.querySelector('.project-modal[open]')) {
          return;
        }

        if (e.key === 'ArrowRight') {
          e.preventDefault();
          moveNext();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          movePrev();
        }
      });
    }
  }

  // --- Modal Logic ---
  const cards = document.querySelectorAll('.project-card');
  const modals = document.querySelectorAll('.project-modal');
  const closeButtons = document.querySelectorAll('.modal-close-btn');

  const syncModalHeights = (modal) => {
      if (!modal) return;
      const mediaCol = modal.querySelector('.modal-media-col');
      if (!mediaCol) return;

      // Wait for layout (aspect-ratio sizing) to settle.
      requestAnimationFrame(() => {
        const height = mediaCol.getBoundingClientRect().height;
        if (height && Number.isFinite(height)) {
          modal.style.setProperty('--modal-left-col-height', `${Math.round(height)}px`);
        }
      });
  };
  
  const openModal = (modal, updateHistory = true) => {
      document.body.style.overflow = 'hidden';
      if (modal.showModal) {
          modal.showModal();
      } else {
          modal.setAttribute('open', '');
      }
      // Reset animations/visibility
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';

      syncModalHeights(modal);

      if (updateHistory) {
         const slug = modal.id.replace('modal-', '');
         history.pushState({ modalId: modal.id }, '', `#${slug}`);
      }
  };

  const closeModal = (modal, updateHistory = true) => {
      document.body.style.overflow = 'hidden'; // Keep hidden during transition to avoid flicker
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
      setTimeout(() => {
        if (modal.close) modal.close();
        else modal.removeAttribute('open');
        document.body.style.overflow = '';
      }, 200);

      if (updateHistory) {
         // Push a clean state without hash
         history.pushState(null, '', window.location.pathname);
      }
  };

  window.addEventListener('resize', () => {
      document.querySelectorAll('.project-modal[open]').forEach(m => syncModalHeights(m));
  });

  const isMobile = window.matchMedia('(max-width: 640px)').matches;

  cards.forEach(card => {
      card.addEventListener('click', (e) => {
          if (e.target.tagName === 'A') return; // let normal links work

          // On mobile, navigate to detail page instead of opening modal
          if (isMobile) {
              const href = card.getAttribute('data-href');
              if (href) window.location.href = href;
              return;
          }

          const targetId = card.getAttribute('data-target');
          const modal = document.querySelector(targetId);
          if (modal) openModal(modal, true);
      });
  });

  closeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
          const modal = btn.closest('.project-modal');
          closeModal(modal, true);
      });
  });

  modals.forEach(modal => {
      modal.addEventListener('click', (e) => {
          if (e.target === modal) {
              closeModal(modal, true);
          }
      });
      // Handle ESC key or native cancel
      modal.addEventListener('cancel', (e) => {
          e.preventDefault(); // Prevent default close to handle animation and history manually
          closeModal(modal, true);
      });
  });

  // Handle browser back/forward buttons
  window.addEventListener('popstate', (e) => {
      // Close any open modals first (without pushing to history again)
      document.querySelectorAll('.project-modal[open]').forEach(m => closeModal(m, false));
      
      const hash = window.location.hash;
      if (hash) {
          const slug = hash.substring(1);
          const modal = document.getElementById(`modal-${slug}`);
          if (modal) {
              openModal(modal, false); 
          }
      }
  });

  // Initial load check
  window.addEventListener('load', () => {
      const hash = window.location.hash;
      if (hash) {
          const slug = hash.substring(1);
          const modal = document.getElementById(`modal-${slug}`);
          if (modal) openModal(modal, false);
      }
  });

  // --- Lightbox Logic ---
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const lightboxClose = document.getElementById('lightbox-close');

  const openLightbox = (src) => {
      if (!lightbox || !lightboxImg) return;
      lightboxImg.src = src;
      // Use showModal to stay in top layer above the opened project modal
      if (lightbox.showModal) lightbox.showModal();
      else {
        lightbox.setAttribute('open', '');
        lightbox.style.display = 'flex';
      }
  };

  const hideLightbox = () => {
      if (!lightbox) return;
      if (lightbox.close) lightbox.close();
      else {
        lightbox.removeAttribute('open');
        lightbox.style.display = 'none';
      }
      
      if (lightboxImg) setTimeout(() => { lightboxImg.src = ''; }, 200); 
  };

  if (lightboxClose) lightboxClose.addEventListener('click', hideLightbox);
  if (lightbox) {
    lightbox.addEventListener('click', (e) => {
        // Close if clicking backend (dialog element itself), not content
        if (e.target === lightbox) hideLightbox();
    });
    // Prevent closing parent modal when pressing escape on lightbox
    lightbox.addEventListener('cancel', (e) => {
        e.stopPropagation();
    });
  }

  // --- Gallery Slideshow Logic ---
  document.querySelectorAll('.gallery-slideshow').forEach(container => {
      const slides = JSON.parse(container.getAttribute('data-slides') || '[]');
      const img = container.querySelector('.slide-image');
      const prevBtn = container.querySelector('.prev');
      const nextBtn = container.querySelector('.next');
      const counter = container.querySelector('.gallery-counter');
      
      let currentIndex = 0;
      
      const updateSlide = () => {
          if (!img) return;

          // Guard for no slides
          if (!Array.isArray(slides) || slides.length === 0) {
              img.removeAttribute('src');
              if (counter) counter.textContent = `0 / 0`;
              if (prevBtn) prevBtn.style.display = 'none';
              if (nextBtn) nextBtn.style.display = 'none';
              return;
          }

          // Clamp currentIndex to valid range
          if (currentIndex < 0) currentIndex = 0;
          if (currentIndex > slides.length - 1) currentIndex = slides.length - 1;

          img.style.opacity = '0.5'; // Simple fade effect
          setTimeout(() => {
            img.src = slides[currentIndex];
            img.setAttribute('data-index', currentIndex);
            img.style.opacity = '1';

            if (counter) {
                counter.textContent = `${currentIndex + 1} / ${slides.length}`;
            }

            // If there's only one slide, hide both controls
            if (slides.length <= 1) {
              if (prevBtn) prevBtn.style.display = 'none';
              if (nextBtn) nextBtn.style.display = 'none';
            } else {
              // Show/hide prev/next depending on position (no wrap)
              if (prevBtn) prevBtn.style.display = (currentIndex === 0) ? 'none' : '';
              if (nextBtn) nextBtn.style.display = (currentIndex === slides.length - 1) ? 'none' : '';
            }
          }, 150);
      };

        if (prevBtn) {
          prevBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // prevent lightbox trigger or other clicks
            if (slides.length <= 1) return;
            if (currentIndex > 0) {
            currentIndex -= 1;
            updateSlide();
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (slides.length <= 1) return;
            if (currentIndex < slides.length - 1) {
            currentIndex += 1;
            updateSlide();
            }
          });
        }
      
      // Click on image opens lightbox
      if (img) {
          img.addEventListener('click', () => {
              openLightbox(slides[currentIndex]);
          });
      }

        // Initialize UI (set button visibility/counter)
        updateSlide();
  });

</script>
